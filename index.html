<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscrição Eletivas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Inscrição para Eletivas</h1>

    <form id="inscricao-form">
        <label for="turma">Turma:</label>
        <select id="turma" required>
            <option value="">Selecione a turma</option>
        </select>

        <label for="nome">Nome:</label>
        <input type="text" id="nome" required placeholder="Digite seu nome">
        
        <label for="eletiva">Eletiva:</label>
        <select id="eletiva" disabled required>
            <option value="">Selecione a eletiva</option>
        </select>

        <button type="submit" id="inscrever-btn" disabled>Inscrever</button>
    </form>

    <h2>Inscrições Realizadas</h2>
    <table id="inscricoes-list">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Turma</th>
                <th>Eletiva</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <!-- Scripts do Firebase -->
    <script type="module">
        // Importar as funções necessárias do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, addDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAqZBVNO_jIjah9v-Tp_Axy1LoMLkaINPU",
            authDomain: "device-streaming-9e3b934a.firebaseapp.com",
            databaseURL: "https://device-streaming-9e3b934a-default-rtdb.firebaseio.com",
            projectId: "device-streaming-9e3b934a",
            storageBucket: "device-streaming-9e3b934a.firebasestorage.app",
            messagingSenderId: "608328398854",
            appId: "1:608328398854:web:706cf69b6dcb751930ab87"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Função para carregar as turmas
        async function carregarTurmas() {
            const turmasRef = collection(db, "alunos");
            const snapshot = await getDocs(turmasRef);
            const turmaSelect = document.getElementById("turma");

            snapshot.forEach(doc => {
                const turma = doc.data().turma;
                const option = document.createElement("option");
                option.value = turma;
                option.textContent = turma;
                turmaSelect.appendChild(option);
            });
        }

        // Função para carregar os alunos de uma turma
        async function carregarAlunos(turma) {
            const alunosRef = collection(db, "alunos");
            const q = query(alunosRef, where("turma", "==", turma));
            const snapshot = await getDocs(q);
            const nomeSelect = document.getElementById("nome");

            nomeSelect.innerHTML = "<option value=''>Selecione o nome</option>"; // Limpar antes de adicionar

            snapshot.forEach(doc => {
                const nomeAluno = doc.data().nomealuno;
                const option = document.createElement("option");
                option.value = nomeAluno;
                option.textContent = nomeAluno;
                nomeSelect.appendChild(option);
            });
        }

        // Função para carregar as eletivas
        async function carregarEletivas() {
            const eletivasRef = collection(db, "eletiva");
            const snapshot = await getDocs(eletivasRef);
            const eletivaSelect = document.getElementById("eletiva");

            eletivaSelect.innerHTML = ""; // Limpar as opções anteriores

            snapshot.forEach(doc => {
                const eletiva = doc.data().nomeEletiva;
                const vagas = doc.data().vagas;
                const option = document.createElement("option");
                option.value = eletiva;
                option.textContent = `${eletiva} (${vagas} vagas)`;
                eletivaSelect.appendChild(option);
            });
        }

        // Função para inscrever o aluno
        async function inscreverAluno(nome, turma, eletiva) {
            const inscricaoRef = collection(db, "inscricao");
            await addDoc(inscricaoRef, {
                nomeAluno: nome,
                turma: turma,
                nomeEletiva: eletiva
            });
            alert("Inscrição realizada com sucesso!");
        }

        // Função para carregar as inscrições
        async function carregarInscricoes() {
            const inscricoesRef = collection(db, "inscricao");
            const snapshot = await getDocs(inscricoesRef);
            const listaInscricoes = document.getElementById("inscricoes-list").getElementsByTagName('tbody')[0];

            listaInscricoes.innerHTML = ""; // Limpar as inscrições anteriores
            snapshot.forEach(doc => {
                const dados = doc.data();
                const row = listaInscricoes.insertRow();
                row.insertCell(0).textContent = dados.nomeAluno;
                row.insertCell(1).textContent = dados.turma;
                row.insertCell(2).textContent = dados.nomeEletiva;
            });
        }

        // Inicialização
        window.onload = async () => {
            carregarTurmas();
            carregarEletivas();
            carregarInscricoes();

            // Event listener para selecionar a turma
            document.getElementById("turma").addEventListener("change", async () => {
                const turma = document.getElementById("turma").value;
                if (turma) {
                    carregarAlunos(turma);
                    document.getElementById("nome").disabled = false;
                } else {
                    document.getElementById("nome").disabled = true;
                }
            });

            // Event listener para inscrição
            document.getElementById("inscricao-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const nome = document.getElementById("nome").value;
                const turma = document.getElementById("turma").value;
                const eletiva = document.getElementById("eletiva").value;

                await inscreverAluno(nome, turma, eletiva);
                carregarInscricoes();
            });
        };
    </script>
</body>
</html>
